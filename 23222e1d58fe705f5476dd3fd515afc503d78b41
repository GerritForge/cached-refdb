{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "1a85046a_97d7eecb",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/BatchRefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 176,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2026-02-03T12:59:06Z",
      "side": 1,
      "message": "If we also update the refs in cache, why not getting the value from the updated SHA1 and put into cache instead of reloading it with a `refsCache.get()`?",
      "range": {
        "startLine": 174,
        "startChar": 0,
        "endLine": 176,
        "endChar": 7
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cef54eef_2b2f1516",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/BatchRefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 176,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T14:14:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "1a85046a_97d7eecb",
      "range": {
        "startLine": 174,
        "startChar": 0,
        "endLine": 176,
        "endChar": 7
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "73040fa8_6ba0cd17",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/CachedRefDatabase.java",
        "patchSetId": 14
      },
      "lineNbr": 175,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2026-02-03T12:59:06Z",
      "side": 1,
      "message": "We are multiplying the work to do here: if the caller is calling with multiple prefixes, expecting to reduce the execution time, we do actually make multiple calls to the single prefix version at L158.\n\nIMHO this should perform a single scan for all prefixes mentioned, rather than multiple scans, one per prefix.",
      "range": {
        "startLine": 162,
        "startChar": 2,
        "endLine": 175,
        "endChar": 18
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "38bf3afa_2dc35d3d",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/CachedRefDatabase.java",
        "patchSetId": 14
      },
      "lineNbr": 175,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T14:14:56Z",
      "side": 1,
      "message": "@luca.milanesio@gmail.com what do you mean by _a single scan for all prefixes mentione_ ? Currently I am using the following API exposed by the underlined data structure:\n\n```\npublic Iterable\u003cString\u003e getKeysWithPrefix(String prefix)\n```\n\nWith this method we inevitably have to call it several times.\n\nThe is also another API which returns all the entries in the tree:\n\n```\npublic Map\u003cString, Value\u003e getAll()\n```\n\nIs that what you had in mind? Get all the refs and leverage the `Map` to check the availabe prefixes?",
      "parentUuid": "73040fa8_6ba0cd17",
      "range": {
        "startLine": 162,
        "startChar": 2,
        "endLine": 175,
        "endChar": 18
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "258a3319_b44f1f7b",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 54,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-02T15:49:17Z",
      "side": 1,
      "message": "The value of `refs_names_by_project` cache (`ObjectId`) is not used at the moment.\nWe could use `Ref` instead and merge the two caches.\n\n__Pros__:\n- Single cache to maintain (no need to keep in sync between them)\n- No side effects in `RefsByProjectLoader` cache loader (L#106)\n- No explicit cache update in `*RefUpdateWithCacheUpdate` (see for example L#175 of `BatchRefUpdateWithCacheUpdate`)\n\n__Cons__:\n- `refs_names_by_project` has a less granular key (`project-refName` Vs `project`). This might lead to higher concurrency on the keys.\n\nWe could decrese the contention by creating a compound key for `refs_names_by_project` like `project-knownPrefix`, i.e.: `foo$refs/heads`, `foo$refs/tags`, but this might be premature.\n\nWDYT?",
      "range": {
        "startLine": 48,
        "startChar": 0,
        "endLine": 54,
        "endChar": 47
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b26fb4a3_17518c76",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 54,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T10:56:09Z",
      "side": 1,
      "message": "Agreed to merge teh caches in a follow up change.",
      "parentUuid": "258a3319_b44f1f7b",
      "range": {
        "startLine": 48,
        "startChar": 0,
        "endLine": 54,
        "endChar": 47
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bfe117d8_362d3010",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 105,
      "author": {
        "id": 1015244
      },
      "writtenOn": "2026-02-03T14:48:14Z",
      "side": 1,
      "message": "Do we ever use the `ObjectId` stored in this cache, as value?\nThis will have a significant memory footprint, especially on large repository, for something we never use.\n\nIf this is just an arbitrary value type and the only reason we are using it is to make build `TernarySearchTree\u003c\u003e` why don\u0027t we store a pointer to a static value?\n\nthought?",
      "range": {
        "startLine": 105,
        "startChar": 37,
        "endLine": 105,
        "endChar": 54
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2bcd66b9_f2fd041d",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 105,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T08:47:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "bfe117d8_362d3010",
      "range": {
        "startLine": 105,
        "startChar": 37,
        "endLine": 105,
        "endChar": 54
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c3a804ea_15ac8cbf",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 178,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2026-02-03T12:59:06Z",
      "side": 1,
      "message": "This is a critical issue: if there are issues in the collection, we just log and return an invalid result.\n\nThe error should be thown and the execution interrupted.",
      "range": {
        "startLine": 177,
        "startChar": 0,
        "endLine": 178,
        "endChar": 75
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "6a13fc67_dd547c47",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 178,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T14:14:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "c3a804ea_15ac8cbf",
      "range": {
        "startLine": 177,
        "startChar": 0,
        "endLine": 178,
        "endChar": 75
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f277fbe6_f99edad0",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 194,
      "author": {
        "id": 1020677
      },
      "writtenOn": "2026-02-02T16:23:41Z",
      "side": 1,
      "message": "this makes me think we\u0027re updating the refByName cache, but really its the refsNamesByProject one, no?",
      "range": {
        "startLine": 194,
        "startChar": 14,
        "endLine": 194,
        "endChar": 29
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8b84d6c1_1c6ad6a7",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 194,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T14:14:56Z",
      "side": 1,
      "message": "Renamed, check if it is better.",
      "parentUuid": "f277fbe6_f99edad0",
      "range": {
        "startLine": 194,
        "startChar": 14,
        "endLine": 194,
        "endChar": 29
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "03a8669d_d0f12f6a",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 197,
      "author": {
        "id": 1020677
      },
      "writtenOn": "2026-02-02T16:23:41Z",
      "side": 1,
      "message": "Is throwing an NPE just because the objectId for the ref is null the correct thing to do here?",
      "range": {
        "startLine": 197,
        "startChar": 0,
        "endLine": 197,
        "endChar": 22
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "da496f8e_3672a5ac",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 197,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T14:14:56Z",
      "side": 1,
      "message": "Not applicable anymore.",
      "parentUuid": "03a8669d_d0f12f6a",
      "range": {
        "startLine": 197,
        "startChar": 0,
        "endLine": 197,
        "endChar": 22
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4f8a346a_b133eb93",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 214,
      "author": {
        "id": 1015244
      },
      "writtenOn": "2026-02-03T14:48:14Z",
      "side": 1,
      "message": "I think we might loose updates here.\n\ntwo threads can do:\n* T1: sees absent, creates A, inserts “x”, puts A\n* T2: sees absent (still), creates B, inserts “y”, puts B\n\nWhichever put() happens last wins\n\n\nShould we not use refsNamesByProject.get(key) and let the loader create the tree, then mutate that returned value? This ensures all threads converge on the same instance for a project.",
      "range": {
        "startLine": 213,
        "startChar": 0,
        "endLine": 214,
        "endChar": 85
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e6dfbe86_1d8ff20b",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefByNameCacheImpl.java",
        "patchSetId": 14
      },
      "lineNbr": 214,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T14:14:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "4f8a346a_b133eb93",
      "range": {
        "startLine": 213,
        "startChar": 0,
        "endLine": 214,
        "endChar": 85
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4d33b4bd_ba113e95",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 152,
      "author": {
        "id": 1015244
      },
      "writtenOn": "2026-02-03T14:48:14Z",
      "side": 1,
      "message": "this should delegate to `forceUpdate`, not tu `update`",
      "range": {
        "startLine": 152,
        "startChar": 40,
        "endLine": 152,
        "endChar": 46
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "afc9579d_4ece6bf8",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 152,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T08:47:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "4d33b4bd_ba113e95",
      "range": {
        "startLine": 152,
        "startChar": 40,
        "endLine": 152,
        "endChar": 46
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f99c87e2_cb07dfba",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 230,
      "author": {
        "id": 1015244
      },
      "writtenOn": "2026-02-03T14:48:14Z",
      "side": 1,
      "message": "is `evictCacheAndUpdate` called for ref-update deletions? if so, the `refsCache.get(repo.getProjectName(), getName())` will return `null`.\nWe should remove the entry from the ternary tree in this case.",
      "range": {
        "startLine": 230,
        "startChar": 6,
        "endLine": 230,
        "endChar": 32
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "91df6fa2_60977b5c",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 230,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T10:56:09Z",
      "side": 1,
      "message": "No, I explicitely added a different method. Deletion calls the `evictCache` method which will remove the entry from the tree.",
      "parentUuid": "f99c87e2_cb07dfba",
      "range": {
        "startLine": 230,
        "startChar": 6,
        "endLine": 230,
        "endChar": 32
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "407541c8_0de04a85",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 230,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T14:14:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "91df6fa2_60977b5c",
      "range": {
        "startLine": 230,
        "startChar": 6,
        "endLine": 230,
        "endChar": 32
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bfcd574b_120e973d",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 231,
      "author": {
        "id": 1020677
      },
      "writtenOn": "2026-02-02T16:23:41Z",
      "side": 1,
      "message": "why are we evicting from one cache and adding into the other?",
      "range": {
        "startLine": 230,
        "startChar": 6,
        "endLine": 231,
        "endChar": 82
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "60c52de7_c5f9e988",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 231,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T10:56:09Z",
      "side": 1,
      "message": "The",
      "parentUuid": "bfcd574b_120e973d",
      "range": {
        "startLine": 230,
        "startChar": 6,
        "endLine": 231,
        "endChar": 82
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7aa0a0eb_3fa9798e",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 231,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2026-02-04T11:54:50Z",
      "side": 1,
      "message": "Agreed with @danielesassoli@gmail.com, it\u0027s confusing indeed.\nWhen you have a method name that has a `and` it means that the method is doing too many things. One method \u003d one thing.\n\nWhy not just splitting into two methods?\n\n- `evictCache()` just evicts the cache\n- `updateCache()` just updates the cache",
      "parentUuid": "60c52de7_c5f9e988",
      "range": {
        "startLine": 230,
        "startChar": 6,
        "endLine": 231,
        "endChar": 82
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9ed9f4d1_c359e5b0",
        "filename": "src/main/java/com/gerritforge/gerrit/plugins/cachedrefdb/RefUpdateWithCacheUpdate.java",
        "patchSetId": 14
      },
      "lineNbr": 231,
      "author": {
        "id": 1012541
      },
      "writtenOn": "2026-02-04T14:14:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "7aa0a0eb_3fa9798e",
      "range": {
        "startLine": 230,
        "startChar": 6,
        "endLine": 231,
        "endChar": 82
      },
      "revId": "23222e1d58fe705f5476dd3fd515afc503d78b41",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    }
  ]
}